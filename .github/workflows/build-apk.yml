name: Build Android APK (Custom Icon)

on:
  push:
    branches: [ "main" ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # Organize files (including your logo!)
    - name: Organize Web Files
      run: |
        mkdir -p www
        mv index.html www/
        mv css www/
        mv js www/
        # We don't move logo.png to www. It stays in root for the asset generator.

    - name: Create package.json
      run: npm init -y

    # Install Capacitor AND the Asset Generator tool
    - name: Install Dependencies
      run: |
        npm install @capacitor/core@5 @capacitor/cli@5 @capacitor/android@5
        npm install @capacitor/assets --save-dev

    - name: Create Capacitor Config
      run: |
        echo '{
          "appId": "com.mystore.app",
          "appName": "My Awesome Store",
          "webDir": "www",
          "bundledWebRuntime": false
        }' > capacitor.config.json

    - name: Add Android Platform
      run: npx cap add android

    # --- NEW STEP: GENERATE ICONS ---
    - name: Generate App Icons
      run: |
        # 1. Create the assets folder structure Capacitor expects
        mkdir -p assets
        
        # 2. Copy your logo.png to be the source for icon and splash screen
        # (We use the same image for both to keep it simple)
        cp logo.png assets/icon.png
        cp logo.png assets/splash.png
        
        # 3. Run the generator tool
        npx capacitor-assets generate --android
        
        # 4. Sync these new assets into the Android project
        npx cap sync android

    - name: Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: android/app/build/outputs/apk/debug/app-debug.apk