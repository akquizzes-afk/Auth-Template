name: Build Android APK From Web Files

# Run on every push to the 'main' branch
on:
  push:
    branches: [ "main" ]

jobs:
  build-android:
    # Use the latest Ubuntu (Linux) runner
    runs-on: ubuntu-latest

    steps:
    # 1. Checks out your repository's code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Sets up Java 17 (CRITICAL FIX)
    # Capacitor 5 requires Java 17. Java 21 causes the "major version 65" crash.
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Sets up the Node.js environment
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 4. Create 'www' dir and move your web files into it
    # We use 'mkdir -p' to ensure no errors if folder exists
    - name: Organize Web Files
      run: |
        mkdir -p www
        mv index.html www/
        mv css www/
        mv js www/
        # Verify the move
        echo "Files in www folder:"
        ls -l www

    # 5. Create a package.json file
    - name: Create package.json
      run: npm init -y

    # 6. Install Capacitor 5 (CRITICAL FIX)
    # Version 5 is stable and works with standard Android SDKs
    - name: Install Capacitor
      run: npm install @capacitor/core@5 @capacitor/cli@5 @capacitor/android@5

    # 7. Create the Capacitor config file
    - name: Create Capacitor Config
      run: |
        echo '{
          "appId": "com.practice.authapp",
          "appName": "Auth Template App",
          "webDir": "www",
          "bundledWebRuntime": false
        }' > capacitor.config.json

    # 8. Add the native Android platform
    - name: Add Android Platform
      run: npx cap add android

    # 9. Build the Debug APK
    # We add 'chmod +x' to ensure the build script is executable
    - name: Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug

    # 10. Upload the built APK as a downloadable file
    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: android/app/build/outputs/apk/debug/app-debug.apk